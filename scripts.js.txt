// ======================
// FIREBASE CONFIG
// ======================

const firebaseConfig = {
  apiKey: "AIzaSyDZJoiUD91FU7NCTLI4pm8AiSHuiOu1QQw",
  authDomain: "jam-and-pickles.firebaseapp.com",
  projectId: "jam-and-pickles",
  storageBucket: "jam-and-pickles.firebasestorage.app",
  messagingSenderId: "750747740220",
  appId: "1:750747740220:web:ad28b5ae3bc878b99c7b39"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;

// ======================
// AUTH FUNCTIONS
// ======================

function signUp() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  auth.createUserWithEmailAndPassword(email, password)
    .catch(err => alert(err.message));
}

function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  auth.signInWithEmailAndPassword(email, password)
    .catch(err => alert(err.message));
}

function logout() {
  auth.signOut();
}

// Detect login state

auth.onAuthStateChanged(user => {

  if (user) {

    currentUser = user;
    document.getElementById("authSection").classList.add("hidden");
    document.getElementById("userSection").classList.remove("hidden");
    document.getElementById("appSection").classList.remove("hidden");

    document.getElementById("userEmail").innerText = user.email;

    loadPlans();

  } else {

    currentUser = null;
    document.getElementById("authSection").classList.remove("hidden");
    document.getElementById("userSection").classList.add("hidden");
    document.getElementById("appSection").classList.add("hidden");

  }

});

// ======================
// AI GENERATION (same as before)
// ======================

const API_KEY = "YOUR_OPENAI_KEY";

async function generatePlan() {

  const ingredients = document.getElementById("ingredients").value;

  if (!ingredients) {
    alert("Enter ingredients.");
    return;
  }

  document.getElementById("loading").classList.remove("hidden");

  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + API_KEY
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: [
        { role: "user", content: "Create a 7 day meal plan using: " + ingredients }
      ]
    })
  });

  const data = await response.json();

  const text = data.choices[0].message.content;

  document.getElementById("result").innerText = text;
  document.getElementById("loading").classList.add("hidden");
}

// ======================
// SAVE PLAN
// ======================

function savePlan() {

  const text = document.getElementById("result").innerText;

  if (!text || !currentUser) return;

  db.collection("plans").add({
    userId: currentUser.uid,
    content: text,
    createdAt: new Date()
  }).then(() => {
    alert("Plan saved!");
    loadPlans();
  });

}

// ======================
// LOAD SAVED PLANS
// ======================

function loadPlans() {

  const container = document.getElementById("savedPlans");
  container.innerHTML = "";

  db.collection("plans")
    .where("userId", "==", currentUser.uid)
    .orderBy("createdAt", "desc")
    .get()
    .then(snapshot => {

      snapshot.forEach(doc => {

        const div = document.createElement("div");
        div.classList.add("planCard");

        div.innerText = doc.data().content;

        container.appendChild(div);

      });

    });

}
